# 伤害计算系统文档

本文档详细描述《绝区零》优化器的伤害计算系统，面向开发者和贡献者。

## 目录

1. [属性系统](#属性系统)
2. [Buff系统](#buff系统)
3. [异常伤害系统](#异常伤害系统)
4. [伤害乘区系统](#伤害乘区系统)
5. [战斗服务](#战斗服务)

---

## 属性系统

### 属性分类

系统采用四层属性架构：

```
局外属性 → 局内基础属性（快照1） → 局内普通buff后（快照2） → 局内转换类buff后（快照3，最终战斗属性）
```

#### 局外属性

**定义**：进入战斗/大世界前的基础属性（不包含任何 Buff）

**数据来源**：
- 角色基础属性（白值）：`Agent.get_bare_stats()`
- 音擎静态属性：`WEngine.get_stats_at_level()`
- 驱动盘静态属性：`DriveDisk.get_stats()`

**说明**：
- 本项目中 Buff 均为局内 Buff：
  - 普通 Buff：只参与快照2（局内普通 buff 后）
  - 转换 Buff：只参与快照3（局内转换类 buff 后）
- 因此局外属性不应包含任何 `out_of_combat_stats` / 角色被动 Buff 之类的概念
- 装备口径：
  - 驱动盘两件套：局外静态属性
  - 驱动盘四件套：局内 Buff（效果触发后按 Buff 规则参与快照2/快照3）
  - 音擎属性：局外静态属性
  - 音擎特效：局内 Buff（效果触发后按 Buff 规则参与快照2/快照3）

#### 局内基础属性（快照1）

**定义**：进入战斗/大世界后的面板属性快照，**未应用任何Buff**

**说明**：这是局外属性经过基础转换后的属性快照，后续计算基于此快照

#### 局内普通buff后（快照2）

**定义**：应用所有普通Buff后的属性快照

**数据来源**：
- 所有激活的普通Buff的 `in_combat_stats`
- 包括角色 Buff、音擎 Buff、队友 Buff 等

**说明**：基于快照1叠加普通Buff后生成的新快照

#### 局内转换类buff后（快照3，最终战斗属性）

**定义**：应用所有转换Buff后的最终属性快照，用于实际伤害计算

**数据来源**：
- 所有激活的转换Buff的 `conversion`
- 转换Buff将一种属性转换为另一种属性

**说明**：基于快照2应用转换Buff后生成的最终快照

### 属性前缀含义

| 前缀 | 含义 | 示例 | 计算方式 |
|------|------|------|----------|
| `_BASE` | 基础属性 | `ATK_BASE`, `HP_BASE`, `DEF_BASE`, `IMPACT` | 等级提供的基础值 |
| `_` | 百分比属性 | `ATK_`, `HP_`, `DEF_`, `IMPACT_` | 基础属性的百分比加成（存储为小数，如0.3表示30%） |
| 无前缀 | 固定值属性 | `ATK`, `HP`, `DEF` | 基础属性的固定值加成 |

**重要说明**：
- 百分比属性存储为小数形式，显示时需乘以100
- 四大基础属性（ATK/HP/DEF/IMPACT）有特殊计算规则

### 属性转换流程

系统采用四层属性架构，后三层是快照：

```
局外属性 → 局内基础属性（第一次快照） → 局内普通buff后（第二次快照） → 局内转换类buff后（第三次快照，最终战斗属性）
```

> 术语对照：第一次快照=快照1，第二次快照=快照2，第三次快照=快照3。

#### 第一次快照：局外 → 局内基础属性

**定义**：进战斗后生成的“无 Buff 面板”属性快照（快照1）。此阶段只包含静态数值：角色白值 + 装备静态属性（音擎/驱动盘等），不包含任何 Buff。

> 说明：文档中不再使用“局外百分比/局外固定值”这种容易与 Buff 混淆的说法；这里的百分比/固定值均指“静态属性词条”（来自装备/面板），不是 Buff。

**计算公式**：
```
快照1基数 = 基础白值 × (1 + Σ静态百分比) + Σ静态固定值
```

**示例**：
```
攻击力 = 1000 × (1 + 0.2) + 200 = 1400
```

**数据来源**：
- 角色基础属性：`Agent.get_bare_stats()`
- 武器属性：`WEngine.get_stats_at_level()`
- 驱动盘属性：`DriveDisk.get_stats()`

**快照说明**：
- 局内基础属性是第一次快照（快照1）
- 后续计算基于第一次快照，不重新计算

#### 第二次快照：局内基础属性 → 局内普通buff后

**定义**：应用所有普通 Buff 后的属性快照（快照2）。

**重要说明（避免误解）**：
- 第二次快照的计算是“逐属性维度独立计算”（ATK/HP/DEF/IMPACT…分别算），不是把所有属性求和后再乘一个倍率。
- 文档中 `Σ` 仅表示“同一属性类型在同一维度上的叠加”（例如所有 `ATK_` 相加），不表示跨属性求和。

**计算公式**：
```
快照2[p] = (快照1[p] + Σ普通Buff的 p_base_add) × (1 + Σ普通Buff的 p_) + Σ普通Buff的 p_flat_add
```

**示例**：
```
以攻击力为例：
- 1400：快照1.ATK
- 0.1：普通 Buff 的 ATK_%（百分比加成）
- 100：普通 Buff 最终平加到 ATK 的固定值项（flat add）

快照2.ATK = 1400 × (1 + 0.1) + 100 = 1640
```

**数据来源**：
- 所有激活的普通Buff的 `in_combat_stats`
- 包括角色Buff、武器Buff、驱动盘Buff、队友Buff等

**快照说明**：
- 局内普通 buff 后是第二次快照（快照2）
- 后续计算基于第二次快照，不重新计算

#### 第三次快照：局内普通buff后 → 局内转换类buff后（最终战斗属性）

**定义**：应用所有转换 Buff 后的最终属性快照（快照3）。

**重要说明（避免误解）**：
- 每个转换 Buff 都以快照2作为计算基准，单独算出“增加值”，互不干扰。
- 所有转换 Buff 的“增加值”在末尾一次性加到快照2上得到快照3；转换结果不会作为其他转换 Buff 的源属性（即不链式、不递归）。

**计算公式**：

**最终汇总公式**：
```
快照3 = 快照2 + Σ(所有转换 Buff 的增加值)
```

**单个转换Buff计算**：
```
转换增益[X] = 源属性[Y] × 转换比例
```

- **源属性[Y]**：默认取自快照2的数值（见上方“重要说明”）。
- **目标属性[X]**：接受增益的属性。

**注意**：Y 和 X 可以是不同属性（如 Y=HP, X=ATK），也可以是相同属性（如 Y=ATK, X=ATK，即苍角类的攻击转攻击）。

**示例**：
```
转换Buff A（生命转攻击）：算出加 200 攻击
转换Buff B（防御转攻击）：算出加 200 攻击
结果：最终攻击 = 局内普通buff后面板攻击 + 200 + 200
```

**数据来源**：
- 转换Buff：定义了 source_stat（源属性）、target_stat（目标属性）、ratio（比例）、max_value（可选上限）。

**完整示例（跨属性转换）**：

假设一个场景：
- 角色A（辅助）：提供基于自身 HP 的攻击力加成给队友
- 源属性：角色A 的 HP（快照2数值）= 10,000
- 转换比例：10% (0.1)
- 转换增益 = 10,000 × 0.1 = 1,000 (固定值 ATK)

角色B（输出）：
- 快照2（局内普通buff后）：ATK = 2,500

计算最终属性（快照3）：
```
最终_ATK = 快照2.ATK (2,500) + 转换增益 (1,000) = 3,500
```

**特殊说明**：

如果有多个转换来源（例如：既有 HP 转 ATK，又有 DEF 转 ATK），则分别计算后累加：
```
最终_ATK = 快照2.ATK + (HP × 比例1) + (DEF × 比例2)
```

**属性计算三步走总结**：

1. **局外属性（同类相加）**：进战斗前生效的属性，所有局外百分比直接相加。
   - 公式：局外基数 = 基础白值 × (1 + Σ局外百分比) + Σ局外固定值

2. **局内属性（同类相加，再乘局外）**：进战斗后生效的Buff，所有局内百分比直接相加，算出一个总倍率，乘在局外基数上。
   - 公式：战斗面板 = 局外基数 × (1 + Σ局内百分比) + Σ局内固定值

3. **转换属性（独立计算，汇总相加）**：各种"属性转属性"的Buff，每个转换Buff单独计算出增加的数值，互不干扰，把所有算出来的增加数值，全部加到战斗面板上。

**最终汇总公式**：
```
最终属性 = [ 局外基数 × (1 + Σ局内%) + Σ局内固定 ] + Σ(所有转换Buff的计算结果)
```

这样修改后，逻辑就完全闭环了：
- 快照1 → 快照2：处理层层乘算的百分比（绝区零特色）。
- 快照2 → 快照3：处理基于面板（源属性）计算出的固定值转换（苍角/赛斯/露西等），确保跨属性转换逻辑正确且不会发生数值死循环。

---

**完整示例（简化版）**：

假设一个角色：
- 局外属性：`ATK_BASE = 1000`, `ATK_ = 0.2`, `ATK = 200`, `HP_BASE = 2000`
- 普通Buff提供：`ATK_BASE_ADD = 300`, `ATK_ = 0.1`, `ATK = 100`
- 转换Buff：将 `HP` 转换为 `ATK`，比例 30%，无阈值

**局外属性**：
```
ATK_BASE = 1000
ATK_ = 0.2
ATK = 200
HP_BASE = 2000
```

**第一次快照（局内基础属性）**：
根据局外属性计算，生成快照：
```
局内基础_ATK = ATK_BASE × (1 + ATK_) + ATK = 1000 × (1 + 0.2) + 200 = 1400
局内基础_HP = HP_BASE = 2000
```

传递给第二层的快照（只存储最终计算值）：
```
快照1 = {
  ATK: 1400,    // 攻击力
  HP: 2000      // 生命值
}
```

**第二次快照（局内普通buff后）**：
基于快照1和普通Buff计算，生成快照：
```
局内普通buff后_ATK = (快照1.ATK + 普通Buff.ATK_BASE_ADD) × (1 + 普通Buff.ATK_) + 普通Buff.ATK
                   = (1400 + 300) × (1 + 0.1) + 100
                   = 1700 × 1.1 + 100
                   = 1970
局内普通buff后_HP = 快照1.HP（2000）
```

传递给第三层的快照：
```
快照2 = {
  ATK: 1970,    // 攻击力
  HP: 2000      // 生命值
}
```

**第三次快照（局内转换类buff后，最终战斗属性）**：
基于第二次快照应用转换Buff，生成最终快照：
```
转换值 = 快照1.HP（2000） × 0.3 = 600

最终_ATK = 快照2.ATK（1970） + 转换值（600） = 2570
最终_HP = 快照2.HP（2000）  // 转换Buff不影响HP
```

最终快照（战斗属性）：
```
快照3 = {
  ATK: 2570,
  HP: 2000
}
```

### 贯穿力计算（仪玄）

贯穿力是一种特殊的攻击属性，用于贯穿伤害计算。

**公式**：
```
贯穿力 = 攻击力 × 0.3 + 生命值上限 × 0.1
```

其中攻击力和生命值都是基础面板属性。

---

## Buff系统

### Buff类型

#### 普通Buff

普通Buff直接提供属性加成。

**属性应用**：
- 普通 Buff 只通过 `in_combat_stats` 生效
- 普通 Buff 只参与快照2（局内普通 buff 后），不会参与局外属性/快照1
- 装备口径：
  - 驱动盘两件套：局外静态属性（不是 Buff）
  - 驱动盘四件套：局内 Buff（是 Buff）
  - 音擎属性：局外静态属性（不是 Buff）
  - 音擎特效：局内 Buff（是 Buff）

#### 转换Buff

转换Buff将一种属性转换为另一种属性。

**转换公式**：
```
转换值 = (源属性 - 阈值) × 转换比例
```

**限制**：
- 如果有阈值，只有超过阈值的部分才参与转换
- 可以设置最大值上限

**源属性计算**：
默认情况下，转换 Buff 的源属性取自快照2（局内普通 buff 后），且各转换 Buff 互不影响（不链式、不递归）。

**示例**：
```
转换：HP → ATK
转换比例：30%
阈值：无（阈值视具体 Buff 而定）

假设快照2.HP = 2000
转换值 = 2000 × 0.3 = 600

该 600 会作为 ATK 的“平加值”加入，用于快照3（局内转换类 buff 后）的最终 ATK。
```

### Buff来源

本项目中，Buff 与属性在数据形态上非常接近：可以把 Buff 理解为“一个提供属性加成的集合”，只是在战斗中按条件启用/停用。

| 来源 | 说明 |
|------|------|
| `AGENT_PASSIVE` | 角色被动（本项目中不存在“局外被动 Buff”，若存在则属于局内 Buff） |
| `AGENT_TALENT` | 角色天赋（若实现为局内效果，则作为 Buff 来源） |
| `TALENT` | 天赋（若实现为局内效果，则作为 Buff 来源） |
| `AGENT_CORE` | 角色核心（若实现为局内效果，则作为 Buff 来源） |
| `WENGINE` | 音擎（局外静态属性；不是 Buff 来源） |
| `WENGINE_TALENT` | 音擎特效/天赋（局内 Buff 来源） |
| `DRIVE_DISK_2PC` | 驱动盘2件套（局外静态属性；不是 Buff 来源） |
| `DRIVE_DISK_4PC` | 驱动盘4件套（局内 Buff 来源） |
| `TEAM_MATE` | 队友 |
| `CORE_PASSIVE` | 核心被动 |
| `POTENTIAL` | 潜力（影画） |

### Buff目标

Buff可以应用于不同的目标：
- 自己：`target_self`
- 敌人：`target_enemy`
- 队友：`target_teammate`
- 邦布：`target_bund`

### Buff激活管理

Buff的激活/停用状态在 `BattleService` 中管理：
- 支持前台/后台角色的不同Buff筛选规则
- 根据技能类型和战斗状态自动激活/停用Buff

---


## 异常伤害系统

### 核心定义（期望计算）

本项目采用社区常用口径：**异常伤害是在异常条打满后一次性爆发的伤害**。

因此计算“期望异常伤害”时，需要先计算本次技能能推进异常条的进度（触发期望），再乘以“打满条时的异常爆发伤害本体”：

```
触发期望 = clamp01(本次技能造成的异常积蓄值 / 异常条阈值)
期望异常伤害 = 触发期望 × 异常爆发伤害本体
```

> 重要说明：异常积蓄相关的乘区用于计算“触发期望”，不是异常爆发伤害本体的伤害乘区。

### 结算时间点（默认 T = 3 秒）

异常伤害与紊乱伤害都与“时间点”强相关：异常触发后会随时间产生伤害（按 tick 跳伤），紊乱触发时会按“剩余持续时间”结算一次性伤害。

为了贴合常见实战节奏并避免全程 10 秒模拟，本优化器采用一个固定结算窗口：

```
T = 3 秒
```

- **异常伤害**：在触发后的 `T` 秒内，按各元素的 tick 间隔统计可造成的伤害次数（离散化为 `floor(T / interval)`），得到用于期望计算的“窗口内异常伤害贡献”。
- **紊乱伤害**：在紊乱触发时，以当前异常状态的“剩余持续时间”作为 `T` 代入紊乱倍率公式，得到一次性紊乱伤害倍率。

> 说明：异常效果的机制默认持续时间仍为 10 秒（且可能被 Buff 改变）；这里的 `T=3` 是优化器固定的计算口径，用于选择统计窗口/剩余时间点。

### 异常伤害乘区

#### 1. 异常积蓄区

**公式**：
```
异常积蓄区 = (异常掌控 / 100) × (1 + 积蓄效率%) × (1 - 敌人积蓄抗性)
```

**有效范围**：`[0, +∞)`

**相关属性**：
- 异常掌控：`ANOM_MAS`
- 通用积蓄效率：`ANOM_BUILDUP_`
- 元素积蓄效率：`PHYSICAL_ANOMALY_BUILDUP_`, `FIRE_ANOMALY_BUILDUP_`, `ICE_ANOMALY_BUILDUP_`, `ELECTRIC_ANOMALY_BUILDUP_`, `ETHER_ANOMALY_BUILDUP_`
- 通用积蓄抗性：`ANOM_BUILDUP_RES_`
- 元素积蓄抗性：`PHYSICAL_ANOM_BUILD_RES_`, `FIRE_ANOM_BUILD_RES_`, `ICE_ANOM_BUILD_RES_`, `ELECTRIC_ANOM_BUILD_RES_`, `ETHER_ANOM_BUILD_RES_`

**计算流程**：
1. 技能基础积蓄值（来自技能数据，如安比四段：172.47）
2. 技能实际积蓄值 = 技能基础积蓄值 × 异常积蓄区
3. 异常触发期望 = clamp01(技能实际积蓄值 / 敌人异常阈值)

**说明**：
- 异常积蓄效率是角色属性，类似攻击力%，表示角色对异常积蓄的加成能力
- 异常积蓄区是计算后的综合乘区，包含异常掌控、积蓄效率、积蓄抗性的综合影响
- 异常触发期望范围 [0, 1]，表示触发概率/进度

#### 2. 异常精通区

**公式**：
```
异常精通区 = 异常精通 / 100
```

**有效范围**：`[0, 10]`

**相关属性**：`ANOM_PROF`

> 有效范围为游戏内设定的硬上限（用于防止数值膨胀）；超过上限的部分按上限处理。

#### 3. 异常增伤区

**公式**：
```
异常增伤区 = 1 + 异常伤害加成
```

**有效范围**：`[0, 3]`

**相关属性**：`ANOMALY_DMG_`

#### 4. 异常暴击区

**公式**：
```
异常暴击区 = 1 + 异常暴击率 × 异常暴击伤害
```

**有效范围**：`[1, 3]`

**相关属性**：
- 异常暴击率：`ANOM_CRIT_`
- 异常暴击伤害：`ANOM_CRIT_DMG_`

#### 5. 等级区

**公式**：
```
等级区 = trunc(1 + 1/59 × (等级 - 1), 4)
```

**有效范围**：`(0, 2]`

**等级区对照**：
- 等级 1：1
- 等级 60：2

### 各元素异常详解

#### 物理异常（强击）

**异常条阈值**：720

**持续伤害倍率**：1250%

**效果**：持续物理伤害，可被强化

#### 火异常（燃烧）

**异常条阈值**：600

**持续伤害倍率**：750%

**效果**：持续火属性伤害，可被强化

#### 冰异常（冻结）

**异常条阈值**：600

**持续伤害倍率**：750%

**效果**：冻结敌人，提供冻结抗性，持续冰属性伤害

#### 电异常（感电）

**异常条阈值**：600

**持续伤害倍率**：750%

**效果**：持续电属性伤害，可被强化

#### 以太异常（侵蚀）

**异常条阈值**：600

**持续伤害倍率**：750%

**效果**：持续以太属性伤害，可被强化

#### 离火异常（烈霜）

**异常条阈值**：600

**持续伤害倍率**：1500%（星见雅专属）

**效果**：特殊离火属性伤害，星见雅专属

### 紊乱伤害

紊乱为一次性伤害，但其倍率与“当前异常状态”和“剩余时间/剩余 tick”相关。

令 `T` 为当前异常状态的剩余持续时间（秒），则紊乱伤害倍率如下（社区常用口径）：

| 异常状态 | 伤害倍率 |
|---------|---------|
| 火属性 [灼烧] | `450% + floor(T / 0.5) × 50%` |
| 电属性 [感电] | `450% + floor(T) × 125%` |
| 以太属性 [侵蚀] | `450% + floor(T / 0.5) × 62.5%` |
| 冰属性 [霜寒] | `450% + floor(T) × 7.5%` |
| 物理 [畏缩] | `450% + floor(T) × 7.5%` |
| 玄墨属性 [侵蚀] | `450% + floor(T / 0.5) × 62.5%` |
| 烈霜属性 [霜寒] | `600% + floor(T) × 75%` |

> 说明：这里仅给出“倍率”计算；紊乱伤害的完整公式仍需要乘以其他适用乘区（如增伤/抗性/防御等），具体以实现为准。

> 实现提示：当前代码中的 `getDisorderRatio()` 若返回常量倍率，属于简化近似，需与上表机制口径对齐。

### 异常触发期望

**公式**：
```
异常触发期望 = clamp01(当前异常积蓄 / 异常条阈值)
```

**当前异常积蓄**：
```
当前异常积蓄 = 异常积蓄区 × 技能基础积蓄值
```

**说明**：当触发期望 ≥ 1 时，异常会立即触发

---


## 伤害乘区系统

### 常规伤害公式

```
常规伤害 = 基础伤害区 × 增伤区 × 暴击区 × 防御区 × 抗性区 × 减易伤区 × 失衡易伤区 × 距离衰减区
```

### 各乘区详解

#### 1. 基础伤害区

**公式**：
```
基础伤害区 = 技能倍率 × 对应属性
```

**四种基础伤害类型**：

**1. 直伤基础伤害区（非命破角色）**
```
直伤基础伤害区 = ATK × 技能倍率
```
- **对应属性**：`ATK`（攻击力）
- **倍率来源**：技能数据中的 `atk_ratio`
- **适用角色**：非命破角色（普通攻击）
- **有效范围**：无上限

**2. 贯穿基础伤害区（命破角色）**
```
贯穿基础伤害区 = SHEER_FORCE × 技能倍率
```
- **对应属性**：`SHEER_FORCE`（贯穿力）
- **贯穿力计算**：`SHEER_FORCE = 攻击力 × 0.3 + 生命值 × 0.1`
- **倍率来源**：技能数据中的 `atk_ratio`
- **适用角色**：命破角色（以仪玄为代表）
- **有效范围**：无上限
- **特殊说明**：无防御区乘区

**3. 异常基础伤害区**
```
异常基础伤害区 = ATK × 异常总倍率
```
- **对应属性**：`ATK`（攻击力）
- **异常倍率**（总倍率）：
  - 灼烧（火）：3.0倍（50% × 6次，3秒内触发）
  - 感电（电）：3.75倍（125% × 3次）
  - 侵蚀（以太）：3.75倍（62.5% × 6次）
  - 碎冰（冰）：5.0倍（一次性）
  - 强击（物理）：7.13倍（一次性）
- **有效范围**：无上限

**4. 烈霜基础伤害区（星见雅专属）**
```
烈霜基础伤害区 = ATK × 15.0
```
- **对应属性**：`ATK`（攻击力）
- **烈霜倍率**：15.0（1500%）
- **适用角色**：星见雅（异常体系角色）
- **特殊说明**：
  - 星见雅不是命破角色
  - 烈霜为“由异常触发的直伤”：伤害结算走直伤乘区（包含防御区），但其期望值需要乘以异常积蓄比例（触发期望）

#### 2. 增伤区

**公式**：
```
增伤区 = 1 + Σ增伤
```

**有效范围**：`[0, 6]`

**包含的增伤类型**：
- 通用增伤：`DMG_`, `COMMON_DMG_`
- 元素增伤：
  - 物理增伤：`PHYSICAL_DMG_`
  - 火属性增伤：`FIRE_DMG_`
  - 冰属性增伤：`ICE_DMG_`
  - 电属性增伤：`ELECTRIC_DMG_`
  - 以太增伤：`ETHER_DMG_`
- 技能增伤：
  - 普通攻击增伤：`NORMAL_ATK_DMG_`
  - 特殊技增伤：`SPECIAL_ATK_DMG_`
  - 强化特殊技增伤：`ENHANCED_SPECIAL_DMG_`
  - 连携技增伤：`CHAIN_ATK_DMG_`
  - 终结技增伤：`ULTIMATE_ATK_DMG_`
  - 冲刺攻击增伤：`DASH_ATK_DMG_`
  - 闪避反击增伤：`DODGE_COUNTER_DMG_`
  - 支援技增伤：`ASSIST_ATK_DMG_`
  - 追加攻击增伤：`ADDL_ATK_DMG_`

#### 3. 暴击区

**公式**：
```
暴击区 = 1 + 暴击率 × 暴击伤害
```

**暴击期望**：
```
暴击期望 = 1 + 暴击率 × 暴击伤害
```

**有效范围**：
- 暴击率：`[0, 1]`
- 暴击伤害：`[0, 5]`
- 暴击区：`[1, 6]`

**基础暴击属性**：
- 代理人：暴击率 5%，暴击伤害 50%
- 敌人：暴击率 0%，暴击伤害 50%

#### 4. 防御区

**公式**：
```
防御区 = 等级基数 / (敌人有效防御 + 等级基数)

等级基数 = 攻击方等级 × 10 + 100

敌人有效防御 = 基础防御 × (1 - 防御降低% - 无视防御%) × (1 - 穿透率%) - 穿透值
```

**有效范围**：`(0, 1]`

**特殊说明**：
- 贯穿伤害跳过防御区（防御区 = 1）
- 秽盾敌人防御力提高 80%
- 相关属性：
  - 防御降低：`DEF_RED_`
  - 无视防御：`DEF_IGN_`
  - 穿透率：`PEN_`
  - 穿透值：`PEN`

#### 5. 抗性区

**公式**：
```
抗性区 = 1 - 敌人抗性 + 通用抗性削弱 + 元素抗性削弱 + 通用抗性无视 + 元素抗性无视
```

**有效范围**：`[0, 2]`

**敌人抗性值**：
- 弱点属性：-20%
- 抗性属性：+20%

**相关属性**：
- 通用抗性削弱：`ENEMY_RES_RED_`
- 通用抗性无视：`RES_IGN_`
- 元素抗性削弱：`PHYSICAL_RES_RED_`, `FIRE_RES_RED_`, `ICE_RES_RED_`, `ELECTRIC_RES_RED_`, `ETHER_RES_RED_`
- 元素抗性无视：`PHYSICAL_RES_IGN_`, `FIRE_RES_IGN_`, `ICE_RES_IGN_`, `ELECTRIC_RES_IGN_`, `ETHER_RES_IGN_`

#### 6. 减易伤区

**公式**：
```
减易伤区 = 1 + 受击方易伤 - 受击方减伤
```

**有效范围**：`[0.2, 2]`

**说明**：当前敌人模型未提供易伤/减伤数据，默认返回 1.0

#### 7. 失衡易伤区

**公式**：
```
失衡时：失衡易伤区 = 1 + 敌人失衡易伤倍率 + buff失衡易伤
未失衡时：失衡易伤区 = 1 + buff失衡易伤
```

**有效范围**：
- 失衡时：`[0.2, 5]`
- 未失衡时：`[1, 3]`

**相关属性**：
- 失衡易伤：`ENEMY_DAZE_VULNERABILITY_`
- 失衡易伤降低：`DAZE_RED_`

#### 8. 贯穿增伤区（仪玄专属）

**公式**：
```
贯穿增伤区 = 1 + 贯穿增伤
```

**有效范围**：`[0.2, 9]`

**相关属性**：`SHEER_DMG_`

**特殊说明**：贯穿伤害无防御区乘区（防御区 = 1）

#### 9. 距离衰减区

**有效范围**：`[0, 1]`

**衰减规则**：

**默认型（比利、丽娜、朱鸢）**：
```
距离 ≤ 15m：距离衰减区 = 1.0
距离 > 15m：距离衰减区 = 0.75 ^ (1 + floor((距离 - 15) / 5))
```
超过15m时伤害衰减25%，每继续远离5m继续衰减25%

**格莉丝型**：
```
距离 ≤ 15m：距离衰减区 = 1.0
距离 > 15m：距离衰减区 = 0.7
```
超过15m时伤害衰减30%

---


## 四种伤害的期望计算

所有伤害类型的期望计算都遵循统一的结构：基础伤害乘以各类乘区。

### 通用乘区

以下乘区适用于所有伤害类型：

| 乘区 | 说明 | 有效范围 |
|------|------|----------|
| 增伤区 | 所有类型的伤害加成 | [0, 6] |
| 抗性区 | 敌人抗性降低和无视 | [0, 2] |
| 承伤区 | 受击方易伤和减伤 | [0.2, 2] |
| 失衡易伤区 | 失衡时额外伤害 | [0.2, 5] |
| 距离区 | 攻击距离衰减 | [0, 1] |
| 等级区 | 等级压制加成 | [0.9, 1.1] |

**通用乘区公式**：
```
通用乘区 = 增伤区 × 抗性区 × 承伤区 × 失衡易伤区 × 距离区 × 等级区
```

### 直伤期望

**公式**：
```
直伤期望 = 直伤基础伤害区 × 防御区 × 暴击区 × 通用乘区
```

**暴击区公式**：
```
暴击区 = 1 + 暴击率 × 暴击伤害
```

**说明**：
- 非命破角色使用
- 只考虑暴击概率（不涉及触发概率）

### 贯穿期望

**公式**：
```
贯穿期望 = 贯穿基础伤害区 × 贯穿增伤区 × 暴击区 × 通用乘区
```

**贯穿增伤区公式**：
```
贯穿增伤区 = 1 + 贯穿增伤
```

**暴击区公式**：
```
暴击区 = 1 + 暴击率 × 暴击伤害
```

**说明**：
- 命破角色使用（如星见雅）
- **无防御区**（贯穿伤害无视防御）
- 额外享受贯穿增伤

### 异常期望

**公式**：
```
异常期望 = 异常基础伤害区 × 异常精通区 × 异常增伤区 × 防御区 × 异常暴击区 × 通用乘区 × 触发期望
```

**异常精通区公式**：
```
异常精通区 = 异常精通 / 100
```

**异常暴击区公式**：
```
异常暴击区 = 1 + 异常暴击率 × 异常暴击伤害
```

**触发期望公式**：
```
触发期望 = (技能基础积蓄值 × 异常积蓄区) / 敌人异常阈值
```

**说明**：
- 两层期望：暴击期望 × 触发期望
- 异常暴击区独立于普通暴击区
- 触发期望范围 [0, 1]，表示触发概率

### 烈霜期望

**公式**：
```
烈霜期望 = 烈霜基础伤害区 × 防御区 × 暴击区 × 通用乘区 × 触发期望
```

**暴击区公式**：
```
暴击区 = 1 + 暴击率 × 暴击伤害
```

**触发期望公式**：
```
触发期望 = (技能基础积蓄值 × 异常积蓄区) / 敌人异常阈值
```

**说明**：
- 星见雅专属特殊异常
- 两层期望：暴击期望 × 触发期望
- 使用冰元素的异常阈值计算
- 使用普通暴击区（非异常暴击）

---

## 战斗服务

本优化器的核心目标是：**计算某个技能在既定战斗假设下的伤害贡献（期望值）**。

不同伤害类型的“期望”来源不同：
- 直伤/贯穿：主要来自暴击期望（暴击区）
- 异常/烈霜：主要来自异常触发期望（积蓄比例，clamp 到 [0,1]），并在固定时间点 `T=3s` 结算窗口内贡献
- 紊乱：一次性伤害，但倍率与触发时点的剩余时间相关；在本优化器中同样按固定时间点 `T=3s` 的口径处理

### 属性获取流程

1. **获取快照1（无 Buff 局内面板）**
   - 调用 `Agent.getCharacterCombatStats()`
   - 该返回值即为快照1：角色白值 + 装备静态属性（音擎属性、驱动盘词条、驱动盘2件套等），不包含任何局内 Buff

2. **加载并筛选候选 Buff**
   - 调用 `BattleService.loadBuffsFromAllAgents()`
   - 候选 Buff 来源通常包括：角色/队友技能效果、音擎特效、驱动盘4件套等（均为局内 Buff）
   - 静态属性（音擎属性、驱动盘2件套等）不应在此阶段作为 Buff 重复叠加

3. **应用普通 Buff → 得到快照2**
   - 调用 `BattleService.mergeCombatProperties()`
   - 将所有激活的普通 Buff（`in_combat_stats`）叠加到快照1，得到快照2

4. **应用转换 Buff → 得到快照3（最终战斗属性）**
   - 调用 `BattleService.convertToFinalStats()`
   - 将所有激活的转换 Buff（`conversion`）应用到快照2，得到快照3
   - 转换 Buff 源属性默认取快照2，不链式、不递归

### Buff加载机制

**加载来源**：
- 前台角色：默认加载与前台相关的 Buff
- 后台角色：根据 Buff 的生效条件/目标决定是否加载
- 队友：根据 Buff 的生效条件/目标决定是否加载

**筛选规则**：
- 只加载激活状态的 Buff
- 根据 Buff 目标筛选（自己/敌人/队友）
- 根据技能类型、战斗状态、前后台等条件筛选

### 伤害计算完整流程

1. **初始化战斗环境**
   - 设置队伍（`setTeam`）
   - 设置敌人（`setEnemy`）
   - 加载Buff（`loadBuffsFromAllAgents`）

2. **获取属性和乘区**
   - 获取角色元素类型
   - 获取快照3（最终战斗属性）
   - 获取敌人属性
   - 更新所有乘区（`updateAllZones`）

3. **计算直伤/贯穿伤害**
   - 判断是否为贯穿伤害（仪玄）
   - 根据伤害类型选择计算方法
   - 应用所有常规伤害乘区（包含暴击区，用于直伤/贯穿的期望计算）

4. **计算异常触发期望**
   - 计算当前异常积蓄
   - 计算异常触发期望（`clamp01(积蓄/阈值)`）

5. **计算异常伤害贡献（固定时间点 T=3s）**
   - 根据元素类型与固定结算窗口 `T=3s` 计算异常 tick 次数/总倍率（离散化 `floor(T/interval)`）
   - 应用异常伤害本体的伤害乘区
   - 乘以异常触发期望得到期望异常伤害贡献

6. **计算紊乱伤害贡献（固定时间点 T=3s）**
   - 以固定口径 `T=3s`（或等价的剩余时间假设）代入紊乱倍率公式，得到一次性紊乱倍率
   - 应用其他适用乘区，得到期望紊乱伤害贡献

7. **计算特殊异常伤害**
   - 如星见雅的烈霜（1500%倍率）
   - 烈霜为“由异常触发的直伤”：结算走直伤乘区，但期望需乘异常触发期望

8. **汇总总伤害**
   ```
   总伤害 = 直伤 + 异常伤害 + 紊乱伤害 + 特殊异常伤害
   ```

### 数据流程图

```
Agent (角色)
  ├── get_bare_stats() → 局外属性
  ├── equipped_wengine → WEngine.getStatsAtLevel()
  ├── equipped_drive_disks → DriveDisk.getStats()
  └── getAllBuffs() → Buff[]

属性快照流程（战斗服务口径）:
  快照1（Agent 提供的无 Buff 局内面板）
    → + 普通 Buff（in_combat_stats）
  快照2（局内普通 buff 后）
    → + 转换 Buff（conversion；源取快照2，不链式）
  快照3（局内转换类 buff 后，最终战斗属性）

Buff (增益)
  ├── in_combat_stats (普通 Buff 属性，仅用于快照2)
  └── conversion (转换 Buff: 源属性 × 转换比例 → 目标属性，仅用于快照3；源属性默认取快照2，不链式)

DamageCalculator (伤害计算器)
  ├── 常规伤害乘区: base, bonus, crit, def, res, dmg_taken, stun_vuln, distance
  ├── 异常伤害乘区: accumulate, prof, dmg, crit
  └── 乘区: level, disorder, special

BattleService (战斗服务)
  ├── 获取快照1: Agent.getCharacterCombatStats()
  ├── 生成快照2: 叠加普通 Buff（in_combat_stats）
  ├── 生成快照3: 应用转换 Buff（conversion；源取快照2，不链式）
  └── calculateTotalDamage() → 计算总伤害
```

---

## 缓存机制

### 属性缓存

为提高性能，以下计算结果会被缓存：
- `mergedInCombatProperties`：合并后的局内属性
- `finalStats`：最终属性集
- `combatStats`：角色局内属性（在 Agent 类中）

**缓存清除**：
当角色、装备、Buff发生变化时，需要调用 `clearPropertyCache()` 清除缓存。

### 异常条阈值缓存

为避免每次查询 `anomalyBarsData`，在 `Enemy` 类中实现缓存：
- `anomalyThresholds`：异常条阈值缓存
- `isThresholdsInitialized`：初始化标志

**默认值**：
- 物理异常：720
- 其他元素：600

---

## 附录

### 属性类型枚举

所有属性类型定义在 `PropertyType` 枚举中，包括：
- 基础属性：`ATK_BASE`, `HP_BASE`, `DEF_BASE`, `IMPACT`
- 百分比属性：`ATK_`, `HP_`, `DEF_`, `IMPACT_`
- 固定值属性：`ATK`, `HP`, `DEF`
- 增伤属性：`DMG_`, `PHYSICAL_DMG_`, `FIRE_DMG_`, `ICE_DMG_`, `ELECTRIC_DMG_`, `ETHER_DMG_`
- 暴击属性：`CRIT_`, `CRIT_DMG_`
- 防御属性：`DEF_RED_`, `DEF_IGN_`, `PEN_`, `PEN`
- 抗性属性：`ENEMY_RES_RED_`, `RES_IGN_`, `PHYSICAL_RES_RED_`, `FIRE_RES_RED_`, 等
- 异常属性：`ANOM_MAS`, `ANOM_PROF`, `ANOMALY_DMG_`, `ANOM_CRIT_`, `ANOM_CRIT_DMG_`
- ... 更多属性类型

### 元素类型枚举

| 元素 | 枚举值 | 中文名 |
|------|--------|--------|
| 物理 | `PHYSICAL` | 物理 |
| 火 | `FIRE` | 火 |
| 冰 | `ICE` | 冰 |
| 电 | `ELECTRIC` | 电 |
| 以太 | `ETHER` | 以太 |
| 离火 | `LIESHUANG` | 离火（烈霜） |

### 技能类型枚举

| 技能 | 枚举值 |
|------|--------|
| 普通攻击 | `NORMAL_ATK` |
| 特殊技 | `SPECIAL_ATK` |
| 强化特殊技 | `ENHANCED_SPECIAL` |
| 连携技 | `CHAIN_ATK` |
| 终结技 | `ULTIMATE_ATK` |
| 冲刺攻击 | `DASH_ATK` |
| 闪避反击 | `DODGE_COUNTER` |
| 支援技 | `ASSIST_ATK` |
| 追加攻击 | `ADDL_ATK` |

---

## 参考资料

- 官方伤害机制文档：`docs/DAMAGE_GUIDE.MD`
- 角色数据生成指南：`docs/CHARACTER_DATA_GENERATION_GUIDE.md`
- 驱动盘数据生成指南：`docs/DRIVE_DISK_DATA_GENERATION_GUIDE.md`

---

## 版本历史

- v1.0.0 (2026-01-30)：初始版本，完整描述伤害计算系统
