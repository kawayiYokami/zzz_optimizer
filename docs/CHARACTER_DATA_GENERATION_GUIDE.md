# 角色BUFF数据生成指南

## 📋 概述

本指南说明如何从原始角色数据（`assets/inventory_data/character/`）生成标准化的角色BUFF数据（`assets/inventory_data/character_data_buff/`）。

**核心原则**：
1. **只生成影响伤害的BUFF**：仅提取核心被动、天赋、潜能觉醒中**能直接影响伤害数值**的增益/减益效果。
2. **不生成触发条件**：触发条件、资源系统、战斗状态等只需在 `trigger_conditions` 字段写文本描述，不生成枚举。
3. **不生成基础数据**：忽略基础属性成长、技能伤害倍率、失衡倍率等。
4. **取最大值**：所有多等级效果（核心被动、天赋、潜能）统一提取**最高等级**（通常为Level 6或7）的数值。

## 🛠️ 提取脚本使用

项目提供了 `scripts/extract_character_info.py` 脚本，用于从角色JSON文件中提取技能描述文本。

### 基本用法

```bash
# 提取指定角色ID的所有技能文本
python scripts/extract_character_info.py <角色ID>

# 示例：提取耀嘉音(1311)的技能
python scripts/extract_character_info.py 1311
```

### 输出内容

脚本会输出角色的：
- **影画（天赋）**：所有影画效果的名称、效果描述、原文描述
- **潜能**：潜能觉醒效果
- **核心技**：核心被动和额外能力的描述

### 使用流程

1. **运行脚本获取原始文本**：
   ```bash
   python scripts/extract_character_info.py 1311
   ```

2. **阅读输出**：
   - 识别能影响伤害的BUFF效果
   - 确认数值对应的等级（优先使用Level 6/7）

3. **参考本指南的解析规则**，将效果转换为标准JSON格式

### 示例输出

```
============================================================
角色: 耀嘉音
============================================================

【影画（天赋）】
----------------------------------------
  [2] 贪心艺术
      效果: [核心被动：《如歌的行板》]中的攻击力提升效果额外提升19%，上限额外提升400点...
      描述: 「这个世界上最闪亮的东西，当然是爱！」...

【核心技】
----------------------------------------
  • 核心被动：《如歌的行板》
    [咏叹华彩]状态下...攻击力提升，提升效果等同于耀嘉音初始攻击力的35%，最高不超过1200点...
```

---

## 🔧 数据模型

### Buff（统一结构）

所有BUFF统一使用以下结构：

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | str | 唯一ID (e.g., `1011_talent_2_1`) |
| `name` | str | 中文名称 (e.g., "天赋-攻击力提升") |
| `description` | str | 原始描述文本 |
| `source` | str | `CORE_PASSIVE`, `TALENT`, `POTENTIAL` |
| `target` | obj | 生效目标对象，详见下文 |
| `in_combat_stats` | dict | 局内生效属性 `{PropertyType: value}` |
| `out_of_combat_stats` | dict | 局外生效属性 `{PropertyType: value}` |
| `conversion` | obj | **转换类配置**（可选），详见下文 |
| `trigger_conditions` | str | 触发条件描述文本 |
| `max_stacks` | int | 最大层数 (默认1) |
| `stack_mode` | str | `linear` (线性叠加), `full_only` (仅满层生效) |

#### 转换类配置 (`conversion`)

当效果是"基于A属性提升B属性"时，使用 `conversion` 字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| `from_property` | str | 源属性 (e.g., `PEN_`) |
| `to_property` | str | 目标属性 (e.g., `PEN_`) |
| `conversion_ratio` | float | 转换比例 (e.g., `0.25` 表示25%) |
| `max_value` | float | 上限 (可选，e.g., `0.30` 表示30%) |

> **重要**：转换类和普通属性可以同时存在，用于描述"转换 + 额外加成"的复合效果。

#### 生效目标 (`BuffTarget`)

| 字段 | 默认 | 判定规则 |
|------|------|----------|
| `target_self` | `true` | 绝大多数情况为真 |
| `target_teammate` | `false` | 描述包含 "全队"、"队友"、"后台角色" 时设为 `true` |
| `target_enemy` | `false` | 描述包含 "敌人防御降低"、"受到的伤害提升" 时设为 `true` |
| `target_bund` | `false` | 描述明确提及对邦布生效时设为 `true` |

#### 示例

**纯转换效果：**
```json
{
  "id": "1311_talent_2_1",
  "name": "贪心艺术",
  "description": "咏叹华彩状态下，队伍中其他角色入场时，耀嘉音和入场角色的攻击力提升...",
  "source": "CORE_PASSIVE",
  "target": { "target_self": true, "target_teammate": true },
  "in_combat_stats": {},
  "out_of_combat_stats": {},
  "conversion": {
    "from_property": "ATK_BASE",
    "to_property": "ATK",
    "conversion_ratio": 0.35,
    "max_value": 1200
  },
  "trigger_conditions": "咏叹华彩状态下，队伍中其他角色通过快速支援、连携技、招架支援或回避支援入场",
  "max_stacks": 1,
  "stack_mode": "full_only"
}
```

**纯增伤效果：**
```json
{
  "id": "1011_talent_6_1",
  "name": "普通攻击伤害提升",
  "description": "普通攻击命中敌人时，伤害提升45%...",
  "source": "TALENT",
  "target": { "target_self": true },
  "in_combat_stats": { "COMMON_DMG_": 0.45 },
  "out_of_combat_stats": {},
  "conversion": null,
  "trigger_conditions": "普通攻击命中敌人时",
  "max_stacks": 1,
  "stack_mode": "full_only"
}
```

**转换 + 额外增伤：**
```json
{
  "id": "1211_core_passive_7_1",
  "name": "穿透率转换",
  "description": "指派杜苏拉或安娜塔莎进行攻击时，队伍中其他角色的穿透率随丽娜自身的穿透率提升...",
  "source": "CORE_PASSIVE",
  "target": { "target_self": true },
  "in_combat_stats": { "PEN_": 0.12 },
  "out_of_combat_stats": {},
  "conversion": {
    "from_property": "PEN_",
    "to_property": "PEN_",
    "conversion_ratio": 0.25,
    "max_value": 0.30
  },
  "trigger_conditions": "指派杜苏拉或安娜塔莎进行攻击时",
  "max_stacks": 1,
  "stack_mode": "full_only"
}
```

---

## 📝 解析规则

### 1. 核心被动 (Core Passive)
*   **忽略 `ExtraProperty`**：不要解析JSON中的 `ExtraProperty` 字段，它是基础面板加成。
*   **仅解析 `Desc`**：只从文字描述中提取效果。
*   **分离效果**：如果一段描述包含多个独立触发的效果，应拆分为多个BUFF。
*   **合并属性**：如果同一触发条件下提升多个属性，放在同一个BUFF的 `stats` 中。

### 2. 天赋 (Talent)
*   **忽略技能等级**：描述中的 "技能等级+2" 不需要生成BUFF。
*   **忽略触发条件描述**：如 "闪避时"、"暴击时" 等条件只需写在 `trigger_conditions` 字段。
*   **机制增强**：如果天赋增强了核心被动的数值，直接作为新BUFF生成。

### 3. 潜能觉醒 (Potential)
*   **只取满级**：忽略 Level 1-5，只生成 Level 6 的数据。
*   **转换上限**：如果描述中有上限（如"最多提升20%"），主要关注转换比例，忽略上限描述。

### 4. 属性分类 (`context`)
*   **OUT_OF_COMBAT**: 
    *   永久生效、无条件。
    *   例："暴击率提升10%"。
*   **IN_COMBAT**:
    *   需要触发条件（"攻击命中时"、"生命值低于50%"）。
    *   有持续时间限制。
    *   针对特定技能的加成（"强化特殊技伤害提升"）。
    *   例："攻击命中敌人时，攻击力提升10%，持续10秒"。

### 5. 以下内容不生成BUFF
以下类型的效果**只需在 `trigger_conditions` 写文本描述**，不生成枚举值：
- 特殊资源系统（绝意值、玄墨值等）
- 战斗状态切换（狙击姿态、明心境等）
- 召唤物/协同攻击机制
- 格挡/招架/闪避相关机制
- 能量回复/充能机制
- 抗打断/无敌/霸体
- 持续时间/冷却限制

---

## 📊 属性映射表 (PropertyType)

> **重要**：以下列表完整对应 `web/optimizer/src/model/base.ts` 中的 `PropertyType` 枚举。生成BUFF时必须使用正确的枚举值。

### 基础属性
| 属性名 | 代码 | 说明 |
|--------|------|------|
| 基础生命值 | `HP_BASE` | 角色等级提供的基础生命值 |
| 基础攻击力 | `ATK_BASE` | 角色等级+武器提供的基础攻击力 |
| 基础防御力 | `DEF_BASE` | 角色等级提供的基础防御力 |
| 基础异常掌控 | `ANOM_MAS_BASE` | 基础异常掌控值 |
| 生命值 | `HP` | 生命值固定值 |
| 生命值% | `HP_` | 生命值百分比加成 |
| 攻击力 | `ATK` | 攻击力固定值 |
| 攻击力% | `ATK_` | 攻击力百分比加成 |
| 防御力 | `DEF` | 防御力固定值 |
| 防御力% | `DEF_` | 防御力百分比加成 |

### 穿透与贯穿
| 属性名 | 代码 | 说明 |
|--------|------|------|
| 穿透值 | `PEN` | 穿透敌人防御的固定值 |
| 穿透率 | `PEN_` | 穿透敌人防御的百分比 |
| 贯穿值 | `SHEER_FORCE` | 贯穿值（无视防御） |
| 贯穿伤害 | `SHEER_DMG_` | 贯穿伤害加成 |

### 无视防御/抗性
| 属性名 | 代码 | 说明 |
|--------|------|------|
| 无视属性抗性 | `RES_IGN_` | 无视敌人属性抗性 |
| 无视防御 | `DEF_IGN_` | 无视敌人防御力 |

### 暴击
| 属性名 | 代码 | 说明 |
|--------|------|------|
| 暴击率 | `CRIT_` / `CRIT_RATE_` | 暴击率百分比加成 |
| 暴击伤害 | `CRIT_DMG_` | 暴击伤害百分比加成 |

### 能量
| 属性名 | 代码 | 说明 |
|--------|------|------|
| 能量自动回复 | `ENER_REGEN` / `ENER_REGEN_` | 能量自动回复值/百分比 |
| 基础能量自动回复 | `BASE_ENER_REGEN` | 基础能量自动回复 |
| 能量获得效率 | `ENER_EFF_` | 能量获得效率百分比 |

### 冲击力与失衡
| 属性名 | 代码 | 说明 |
|--------|------|------|
| 冲击力 | `IMPACT` / `IMPACT_` | 冲击力固定值/百分比 |
| 失衡值提升 | `DAZE_INC_` | 攻击造成的失衡值增加 |
| 喧响值获取提升 | `FEVER_GAIN_` | 获取喧响值的效率提升 |

### 护盾
| 属性名 | 代码 | 说明 |
|--------|------|------|
| 护盾效果 | `SHIELD_` | 护盾效果百分比 |

### 异常掌控
| 属性名 | 代码 | 说明 |
|--------|------|------|
| 异常掌控 | `ANOM_MAS` / `ANOM_MAS_` / `ANOM_MASTERY_` | 异常掌控固定值/百分比 |

### 异常精通
| 属性名 | 代码 | 说明 |
|--------|------|------|
| 异常精通 | `ANOM_PROF` | 异常精通值 |

### 异常积蓄
| 属性名 | 代码 | 说明 |
|--------|------|------|
| 异常积蓄效率 | `ANOM_BUILDUP_` | 通用异常积蓄效率 |
| 物理异常积蓄效率 | `PHYSICAL_ANOMALY_BUILDUP_` | 物理属性异常积蓄效率 |
| 火异常积蓄效率 | `FIRE_ANOMALY_BUILDUP_` | 火属性异常积蓄效率 |
| 冰异常积蓄效率 | `ICE_ANOMALY_BUILDUP_` | 冰属性异常积蓄效率 |
| 电异常积蓄效率 | `ELECTRIC_ANOMALY_BUILDUP_` | 电属性异常积蓄效率 |
| 以太异常积蓄效率 | `ETHER_ANOMALY_BUILDUP_` | 以太属性异常积蓄效率 |

### 异常暴击与倍率
| 属性名 | 代码 | 说明 |
|--------|------|------|
| 异常暴击率 | `ANOM_CRIT_` | 属性异常暴击率 |
| 异常暴击伤害 | `ANOM_CRIT_DMG_` | 属性异常暴击伤害 |
| 异常伤害倍率提升 | `ANOM_MV_MULT_` | 属性异常伤害倍率提升 |
| 额外紊乱倍率 | `ADDL_DISORDER_` | 紊乱伤害额外加成 |
| 异常基础伤害提升 | `ANOM_BASE_` | 属性异常基础伤害提升 |
| 异常固定伤害加成 | `ANOM_FLAT_DMG` | 属性异常固定伤害加成 |

### 特定异常伤害
| 属性名 | 代码 | 说明 |
|--------|------|------|
| 灼烧伤害加成 | `BURN_DMG_` | 灼烧异常伤害加成 |
| 感电伤害加成 | `SHOCK_DMG_` | 感电异常伤害加成 |
| 侵蚀伤害加成 | `CORRUPTION_DMG_` | 侵蚀异常伤害加成 |
| 碎冰伤害加成 | `SHATTER_DMG_` | 碎冰异常伤害加成 |
| 强击伤害加成 | `ASSAULT_DMG_` | 强击异常伤害加成 |

### 通用伤害加成
| 属性名 | 代码 | 说明 |
|--------|------|------|
| 伤害加成（通用） | `COMMON_DMG_` / `DMG_` | 所有伤害类型的百分比加成 |
| 固定伤害加成 | `FLAT_DMG` | 固定值伤害加成 |

### 技能伤害加成
| 属性名 | 代码 | 说明 |
|--------|------|------|
| 普通攻击伤害 | `NORMAL_ATK_DMG_` | 普通攻击伤害加成 |
| 强化特殊技伤害 | `ENHANCED_SPECIAL_DMG_` | 强化特殊技伤害加成 |
| 连携技伤害 | `CHAIN_ATK_DMG_` | 连携技伤害加成 |
| 终结技伤害 | `ULTIMATE_ATK_DMG_` | 终结技伤害加成 |
| 冲刺攻击伤害 | `DASH_ATK_DMG_` | 冲刺攻击伤害加成 |
| 闪避反击伤害 | `DODGE_COUNTER_DMG_` | 闪避反击伤害加成 |
| 支援攻击伤害 | `ASSIST_ATK_DMG_` | 支援攻击伤害加成 |
| 追加攻击伤害 | `ADDL_ATK_DMG_` | 追加攻击伤害加成 |
| 特殊技伤害 | `SPECIAL_ATK_DMG_` | 特殊技伤害加成 |

### 元素伤害加成
| 属性名 | 代码 | 说明 |
|--------|------|------|
| 物理伤害 | `PHYSICAL_DMG_` | 物理伤害百分比加成 |
| 以太伤害 | `ETHER_DMG_` | 以太伤害百分比加成 |
| 电属性伤害 | `ELECTRIC_DMG_` | 电属性伤害百分比加成 |
| 冰属性伤害 | `ICE_DMG_` | 冰属性伤害百分比加成 |
| 火属性伤害 | `FIRE_DMG_` | 火属性伤害百分比加成 |

### 属性异常伤害
| 属性名 | 代码 | 说明 |
|--------|------|------|
| 强击伤害 | `IMPACT_DMG_` | 强击属性异常伤害加成 |
| 冻结伤害 | `FREEZE_DMG_` | 冻结属性异常伤害加成 |

### 特殊伤害类型
| 属性名 | 代码 | 说明 |
|--------|------|------|
| 贯穿伤害 | `PENETRATION_DMG_` | 贯穿伤害加成 |
| 紊乱伤害 | `DISORDER_DMG_` | 紊乱伤害加成 |
| 属性异常伤害 | `ANOMALY_DMG_` | 所有属性异常伤害加成 |

### Debuff (作用于敌人)
| 属性名 | 代码 | 说明 |
|--------|------|------|
| 防御降低 | `DEF_RED_` | 减少敌人防御力百分比 |
| 敌人属性抗性 | `ENEMY_RES_` | 敌人基础属性抗性 |
| 属性抗性降低 | `ENEMY_RES_RED_` | 减少敌人属性抗性 |
| 无视敌人属性抗性 | `ENEMY_RES_IGN_` | 无视敌人属性抗性 |
| 异常积蓄抗性 | `ANOM_BUILDUP_RES_` | 减少敌人异常积蓄抗性 |
| 敌人失衡抗性 | `DAZE_RES_` | 减少敌人失衡抗性 |
| 敌人失衡易伤 | `DAZE_RED_` | 敌人承受失衡值增加 |
| 敌人易伤 | `DMG_INC_` / `DAMAGE_TAKEN_RED_` | 敌人承受伤害增加 |

---

## 🔄 叠层机制说明

某些BUFF可以叠加多层，需要在 `max_stacks` 和 `stack_mode` 中正确配置：
- `max_stacks`: 最大可叠加层数（如8层）
- `stack_mode`: 
  - `linear`: 每层提供独立效果，可线性叠加
  - `full_only`: 仅满层时生效

---

## ✅ 验证清单

1.  [ ] **ID唯一性**：确保 `id` 不重复。
2.  [ ] **最高等级**：确认数值取自 Level 6/7。
3.  [ ] **枚举准确**：属性Key必须匹配 `PropertyType` 枚举。
4.  [ ] **Target正确**：Debuff必须标记 `target_enemy: true`，光环必须标记 `target_teammate: true`。
5.  [ ] **无冗余**：不包含技能倍率、不包含技能等级加成。
6.  [ ] **触发条件文本化**：触发条件、资源系统等只需写文本，不生成枚举。
